#include <Arduino.h>
#include "simple_oled.h"

// OLED引脚配置 - 使用软I2C避免冲突
#define OLED_SDA_PIN PA4
#define OLED_SCL_PIN PA5
#define OLED_ADDRESS 0x3C

// 软I2C实现 - 改进时序
void I2C_Start(void) {
    pinMode(OLED_SDA_PIN, OUTPUT);
    pinMode(OLED_SCL_PIN, OUTPUT);
    digitalWrite(OLED_SDA_PIN, HIGH);
    digitalWrite(OLED_SCL_PIN, HIGH);
    delayMicroseconds(5);
    digitalWrite(OLED_SDA_PIN, LOW);
    delayMicroseconds(5);
    digitalWrite(OLED_SCL_PIN, LOW);
    delayMicroseconds(5);
}

void I2C_Stop(void) {
    digitalWrite(OLED_SDA_PIN, LOW);
    digitalWrite(OLED_SCL_PIN, HIGH);
    delayMicroseconds(5);
    digitalWrite(OLED_SDA_PIN, HIGH);
    delayMicroseconds(5);
}

void I2C_WriteByte(uint8_t data) {
    for(uint8_t i = 0; i < 8; i++) {
        digitalWrite(OLED_SDA_PIN, (data & 0x80) ? HIGH : LOW);
        delayMicroseconds(5);
        digitalWrite(OLED_SCL_PIN, HIGH);
        delayMicroseconds(5);
        digitalWrite(OLED_SCL_PIN, LOW);
        delayMicroseconds(2);
        data <<= 1;
    }
    // ACK检查
    pinMode(OLED_SDA_PIN, INPUT);
    digitalWrite(OLED_SDA_PIN, HIGH);
    delayMicroseconds(2);
    digitalWrite(OLED_SCL_PIN, HIGH);
    delayMicroseconds(5);
    digitalWrite(OLED_SCL_PIN, LOW);
    pinMode(OLED_SDA_PIN, OUTPUT);
    digitalWrite(OLED_SDA_PIN, LOW);
    delayMicroseconds(2);
}

void OLED_WriteCommand(uint8_t cmd) {
    I2C_Start();
    I2C_WriteByte(OLED_ADDRESS << 1);  // 写地址
    I2C_WriteByte(0x00);               // 命令模式
    I2C_WriteByte(cmd);
    I2C_Stop();
}

void OLED_WriteData(uint8_t data) {
    I2C_Start();
    I2C_WriteByte(OLED_ADDRESS << 1);  // 写地址
    I2C_WriteByte(0x40);               // 数据模式
    I2C_WriteByte(data);
    I2C_Stop();
}

// 6x8字体 (简化版本)
const uint8_t Font6x8[][6] = {
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // ' '
    {0x00, 0x00, 0x5F, 0x00, 0x00, 0x00}, // '!'
    {0x00, 0x07, 0x00, 0x07, 0x00, 0x00}, // '"'
    {0x14, 0x7F, 0x14, 0x7F, 0x14, 0x00}, // '#'
    {0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x00}, // '$'
    {0x23, 0x13, 0x08, 0x64, 0x62, 0x00}, // '%'
    {0x36, 0x49, 0x55, 0x22, 0x50, 0x00}, // '&'
    {0x00, 0x05, 0x03, 0x00, 0x00, 0x00}, // '''
    {0x00, 0x1C, 0x22, 0x41, 0x00, 0x00}, // '('
    {0x00, 0x41, 0x22, 0x1C, 0x00, 0x00}, // ')'
    {0x08, 0x2A, 0x1C, 0x2A, 0x08, 0x00}, // '*'
    {0x08, 0x08, 0x3E, 0x08, 0x08, 0x00}, // '+'
    {0x00, 0x50, 0x30, 0x00, 0x00, 0x00}, // ','
    {0x08, 0x08, 0x08, 0x08, 0x08, 0x00}, // '-'
    {0x00, 0x60, 0x60, 0x00, 0x00, 0x00}, // '.'
    {0x20, 0x10, 0x08, 0x04, 0x02, 0x00}, // '/'
    {0x3E, 0x51, 0x49, 0x45, 0x3E, 0x00}, // '0'
    {0x00, 0x42, 0x7F, 0x40, 0x00, 0x00}, // '1'
    {0x42, 0x61, 0x51, 0x49, 0x46, 0x00}, // '2'
    {0x21, 0x41, 0x45, 0x4B, 0x31, 0x00}, // '3'
    {0x18, 0x14, 0x12, 0x7F, 0x10, 0x00}, // '4'
    {0x27, 0x45, 0x45, 0x45, 0x39, 0x00}, // '5'
    {0x3C, 0x4A, 0x49, 0x49, 0x30, 0x00}, // '6'
    {0x01, 0x71, 0x09, 0x05, 0x03, 0x00}, // '7'
    {0x36, 0x49, 0x49, 0x49, 0x36, 0x00}, // '8'
    {0x06, 0x49, 0x49, 0x29, 0x1E, 0x00}, // '9'
    {0x00, 0x36, 0x36, 0x00, 0x00, 0x00}, // ':'
    {0x00, 0x56, 0x36, 0x00, 0x00, 0x00}, // ';'
    {0x00, 0x08, 0x14, 0x22, 0x41, 0x00}, // '<'
    {0x14, 0x14, 0x14, 0x14, 0x14, 0x00}, // '='
    {0x00, 0x41, 0x22, 0x14, 0x08, 0x00}, // '>'
    {0x02, 0x01, 0x51, 0x09, 0x06, 0x00}, // '?'
    {0x32, 0x49, 0x79, 0x41, 0x3E, 0x00}, // '@'
    {0x7E, 0x11, 0x11, 0x11, 0x7E, 0x00}, // 'A'
    {0x7F, 0x49, 0x49, 0x49, 0x36, 0x00}, // 'B'
    {0x3E, 0x41, 0x41, 0x41, 0x22, 0x00}, // 'C'
    {0x7F, 0x41, 0x41, 0x22, 0x1C, 0x00}, // 'D'
    {0x7F, 0x49, 0x49, 0x49, 0x41, 0x00}, // 'E'
    {0x7F, 0x09, 0x09, 0x09, 0x01, 0x00}, // 'F'
    {0x3E, 0x41, 0x49, 0x49, 0x7A, 0x00}, // 'G'
    {0x7F, 0x08, 0x08, 0x08, 0x7F, 0x00}, // 'H'
    {0x00, 0x41, 0x7F, 0x41, 0x00, 0x00}, // 'I'
    {0x20, 0x40, 0x41, 0x3F, 0x01, 0x00}, // 'J'
    {0x7F, 0x08, 0x14, 0x22, 0x41, 0x00}, // 'K'
    {0x7F, 0x40, 0x40, 0x40, 0x40, 0x00}, // 'L'
    {0x7F, 0x02, 0x0C, 0x02, 0x7F, 0x00}, // 'M'
    {0x7F, 0x04, 0x08, 0x10, 0x7F, 0x00}, // 'N'
    {0x3E, 0x41, 0x41, 0x41, 0x3E, 0x00}, // 'O'
    {0x7F, 0x09, 0x09, 0x09, 0x06, 0x00}, // 'P'
    {0x3E, 0x41, 0x51, 0x21, 0x5E, 0x00}, // 'Q'
    {0x7F, 0x09, 0x19, 0x29, 0x46, 0x00}, // 'R'
    {0x46, 0x49, 0x49, 0x49, 0x31, 0x00}, // 'S'
    {0x01, 0x01, 0x7F, 0x01, 0x01, 0x00}, // 'T'
    {0x3F, 0x40, 0x40, 0x40, 0x3F, 0x00}, // 'U'
    {0x1F, 0x20, 0x40, 0x20, 0x1F, 0x00}, // 'V'
    {0x7F, 0x20, 0x18, 0x20, 0x7F, 0x00}, // 'W'
    {0x63, 0x14, 0x08, 0x14, 0x63, 0x00}, // 'X'
    {0x03, 0x04, 0x78, 0x04, 0x03, 0x00}, // 'Y'
    {0x61, 0x51, 0x49, 0x45, 0x43, 0x00}, // 'Z'
    {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, // '['
    {0x02, 0x04, 0x08, 0x10, 0x20, 0x00}, // '\'
    {0x00, 0x00, 0x7F, 0x41, 0x41, 0x00}, // ']'
    {0x04, 0x02, 0x01, 0x02, 0x04, 0x00}, // '^'
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x00}, // '_'
    {0x00, 0x01, 0x02, 0x04, 0x00, 0x00}, // '`'
    {0x20, 0x54, 0x54, 0x54, 0x78, 0x00}, // 'a'
    {0x7F, 0x48, 0x44, 0x44, 0x38, 0x00}, // 'b'
    {0x38, 0x44, 0x44, 0x44, 0x20, 0x00}, // 'c'
    {0x38, 0x44, 0x44, 0x48, 0x7F, 0x00}, // 'd'
    {0x38, 0x54, 0x54, 0x54, 0x18, 0x00}, // 'e'
    {0x08, 0x7E, 0x09, 0x01, 0x02, 0x00}, // 'f'
    {0x08, 0x14, 0x54, 0x54, 0x3C, 0x00}, // 'g'
    {0x7F, 0x08, 0x04, 0x04, 0x78, 0x00}, // 'h'
    {0x00, 0x44, 0x7D, 0x40, 0x00, 0x00}, // 'i'
    {0x20, 0x40, 0x44, 0x3D, 0x00, 0x00}, // 'j'
    {0x00, 0x7F, 0x10, 0x28, 0x44, 0x00}, // 'k'
    {0x00, 0x41, 0x7F, 0x40, 0x00, 0x00}, // 'l'
    {0x7C, 0x04, 0x18, 0x04, 0x78, 0x00}, // 'm'
    {0x7C, 0x08, 0x04, 0x04, 0x78, 0x00}, // 'n'
    {0x38, 0x44, 0x44, 0x44, 0x38, 0x00}, // 'o'
    {0x7C, 0x14, 0x14, 0x14, 0x08, 0x00}, // 'p'
    {0x08, 0x14, 0x14, 0x18, 0x7C, 0x00}, // 'q'
    {0x7C, 0x08, 0x04, 0x04, 0x08, 0x00}, // 'r'
    {0x48, 0x54, 0x54, 0x54, 0x20, 0x00}, // 's'
    {0x04, 0x3F, 0x44, 0x40, 0x20, 0x00}, // 't'
    {0x3C, 0x40, 0x40, 0x20, 0x7C, 0x00}, // 'u'
    {0x1C, 0x20, 0x40, 0x20, 0x1C, 0x00}, // 'v'
    {0x3C, 0x40, 0x30, 0x40, 0x3C, 0x00}, // 'w'
    {0x44, 0x28, 0x10, 0x28, 0x44, 0x00}, // 'x'
    {0x0C, 0x50, 0x50, 0x50, 0x3C, 0x00}, // 'y'
    {0x44, 0x64, 0x54, 0x4C, 0x44, 0x00}, // 'z'
    {0x00, 0x08, 0x36, 0x41, 0x00, 0x00}, // '{'
    {0x00, 0x00, 0x77, 0x00, 0x00, 0x00}, // '|'
    {0x00, 0x41, 0x36, 0x08, 0x00, 0x00}, // '}'
    {0x02, 0x01, 0x02, 0x04, 0x02, 0x00}, // '~'
};

// 初始化OLED（无串口调试版本）
void SimpleOLED_Init(void) {
    delay(100);  // 等待OLED上电
    
    // 发送初始化命令序列
    OLED_WriteCommand(0xAE);  // 关闭显示
    delay(5);
    OLED_WriteCommand(0xD5); // 设置时钟分频
    OLED_WriteCommand(0x80);
    OLED_WriteCommand(0xA8); // 设置多路复用率
    OLED_WriteCommand(0x3F); // 64行
    OLED_WriteCommand(0xD3); // 设置显示偏移
    OLED_WriteCommand(0x00);
    OLED_WriteCommand(0x40); // 设置显示起始行
    OLED_WriteCommand(0x8D); // 电荷泵设置
    OLED_WriteCommand(0x14); // 启用电荷泵
    OLED_WriteCommand(0x20); // 内存寻址模式
    OLED_WriteCommand(0x00); // 水平寻址模式
    OLED_WriteCommand(0xA1); // 段重映射
    OLED_WriteCommand(0xC8); // COM扫描方向
    OLED_WriteCommand(0xDA); // COM引脚配置
    OLED_WriteCommand(0x12);
    OLED_WriteCommand(0x81); // 对比度设置
    OLED_WriteCommand(0xCF); // 高对比度
    OLED_WriteCommand(0xD9); // 预充电周期
    OLED_WriteCommand(0xF1);
    OLED_WriteCommand(0xDB); // VCOMH电压
    OLED_WriteCommand(0x40);
    OLED_WriteCommand(0xA4); // 全局显示开启
    OLED_WriteCommand(0xA6); // 设置显示方式：正常
    OLED_WriteCommand(0xAF); // 开启显示
    
    delay(100);
    SimpleOLED_Clear();
}

// 清屏
void SimpleOLED_Clear(void) {
    for(uint8_t page = 0; page < 8; page++) {  // 修正：128x64 OLED有8页
        OLED_WriteCommand(0xB0 + page);  // 设置页地址
        OLED_WriteCommand(0x00);         // 设置列低地址
        OLED_WriteCommand(0x10);         // 设置列高地址
        
        for(uint8_t col = 0; col < 128; col++) {
            OLED_WriteData(0x00);
        }
    }
}

// 设置光标位置
void SetCursor(uint8_t x, uint8_t y) {
    OLED_WriteCommand(0xB0 + y);              // 页地址
    OLED_WriteCommand(((x & 0xF0) >> 4) | 0x10); // 列高地址
    OLED_WriteCommand((x & 0x0F) | 0x00);     // 修正：列低地址应该是0x0F，不是0x01
}

// 显示字符
void ShowChar(uint8_t x, uint8_t y, char ch) {
    uint8_t index;
    
    if(ch >= ' ') index = ch - ' ';
    else index = 0;
    
    SetCursor(x, y);
    for(uint8_t i = 0; i < 6; i++) {
        OLED_WriteData(Font6x8[index][i]);
    }
}

// 显示字符串
void SimpleOLED_ShowString(uint8_t x, uint8_t y, const char* str) {
    uint8_t pos = x;
    while(*str) {
        ShowChar(pos, y, *str);
        pos += 6;
        if(pos >= 122) {  // 边界检查
            pos = 0;
            y++;
            if(y >= 4) break;
        }
        str++;
    }
}

// 检测OLED是否存在
bool SimpleOLED_Detect(void) {
    I2C_Start();
    I2C_WriteByte(OLED_ADDRESS << 1);  // 写地址
    
    // 检查ACK
    pinMode(OLED_SDA_PIN, INPUT);
    digitalWrite(OLED_SDA_PIN, HIGH);
    delayMicroseconds(2);
    digitalWrite(OLED_SCL_PIN, HIGH);
    delayMicroseconds(5);
    
    bool ack = (digitalRead(OLED_SDA_PIN) == LOW);  // ACK = LOW
    
    digitalWrite(OLED_SCL_PIN, LOW);
    pinMode(OLED_SDA_PIN, OUTPUT);
    I2C_Stop();
    
    return ack;
}

// 连接检查函数
void SimpleOLED_ShowCheck(void) {
    // 检测OLED是否存在
    bool detected = SimpleOLED_Detect();
    
    if(detected) {
        SimpleOLED_ShowString(0, 0, "OLED Connected");
        SimpleOLED_ShowString(0, 1, "PA4: SDA OK");
        SimpleOLED_ShowString(0, 2, "PA5: SCL OK");
        SimpleOLED_ShowString(0, 3, "Init Success");
    } else {
        // 即使检测不到也尝试显示连接错误信息
        SimpleOLED_ShowString(0, 0, "OLED ERROR");
        SimpleOLED_ShowString(0, 1, "Check PA4 SDA");
        SimpleOLED_ShowString(0, 2, "Check PA5 SCL");
        SimpleOLED_ShowString(0, 3, "Power 3.3V");
    }
}

// 测试函数
void SimpleOLED_Test(void) {
    SimpleOLED_ShowString(0, 0, "OLED Test OK");
    SimpleOLED_ShowString(0, 1, "PA0: Working");
    SimpleOLED_ShowString(0, 2, "PC13: LED Blink");
    SimpleOLED_ShowString(0, 3, "System Ready");
}